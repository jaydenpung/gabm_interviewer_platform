{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block custom_head_content %}
  <style>
    .module-title {
      font-weight:800;
    }

    #consent_form input {
      margin-bottom:1.2em
    }

    .active_module {
      border-width:3px !important;
      border-color: #F72C25 !important;
    }
  </style>

  <link rel="stylesheet" href="{% static 'gabm/sneat/assets/vendor/libs/select2/select2.css' %}" />
  <link rel="stylesheet" href="{% static 'gabm/sneat/assets/vendor/libs/@form-validation/umd/styles/index.min.css' %}" />
  <link rel="stylesheet" href="{% static 'gabm/sneat/assets/vendor/libs/bs-stepper/bs-stepper.css' %}" />
{% endblock custom_head_content %}

{% block content %}
  <div class="content-wrapper">

    <div class="container-xxl flex-grow-1 container-p-y">
      <h4 class="py-3 mb-4">Study Components and Instructions</h4>

      <div class="card g-3 mt-5" style="margin-top:0em !important">
        <div class="card-body row g-3">
          
          <div class="col-lg-8">

            <div class="card-body">
              <div class="added-cards">

                <div class="cardMaster border p-3 rounded mb-3 {% if curr_module == 'Consent' %}active_module{% endif %}">
                  <div class="d-flex justify-content-between flex-sm-row flex-column">
                    <div class="card-information" style="width: 75%">
                      <p>
                        <i class="menu-icon tf-icons bx bx-file"></i>
                        Preparation Pt. 1
                      </p>
                      <div class="d-flex align-items-center mb-1">
                        <h6 class="mb-0 me-3 module-title">Review the Consent Form</h6>
                        {% if curr_module == "Consent" %}
                          <span class="badge bg-label-primary me-1">Do this next!</span>
                        {% endif %}
                      </div>
                      <span>
                        In this module, you will be providing consent to participating this study.
                        {% if "Consent" in completed_modules %}
                        <br>
                        <br>
                        (For your record, you can find the consent form <a href="https://docs.google.com/document/d/1Y6aBgfJFNT9ZtiiihHc1_oJbjTCgZ1btiNoxCNFMQnU/edit?usp=sharing" target="_blank">here</a>.)
                        {% endif %}
                      </span>
                    </div>
                    <div class="d-flex flex-column text-start text-lg-end">
                      <div class="d-flex order-sm-0 order-1">
                        {% if curr_module == "Consent" %}
                          <button type="button" class="btn btn-label-primary" data-bs-toggle="modal" data-bs-target="#consentForm">Start the Module</button>
                        {% elif "Consent" in completed_modules %}
                          <button class="btn btn-label-secondary" disabled>Done</button>
                        {% else %}
                          <button class="btn btn-label-secondary" disabled>Start the Module</button>
                        {% endif %}
                      </div>
                      <small class="mt-sm-auto mt-2 order-sm-1 order-0">Est. 2 minutes</small>
                    </div>
                  </div>
                </div>

                <div class="cardMaster border p-3 rounded mb-3 {% if curr_module == 'Avatar' %}active_module{% endif %}">
                  <div class="d-flex justify-content-between flex-sm-row flex-column">
                    <div class="card-information" style="width: 75%">
                      <p>
                        <i class="menu-icon tf-icons bx bx-file"></i>
                        Preparation Pt. 2
                      </p>
                      <div class="d-flex align-items-center mb-1">
                        <h6 class="mb-0 me-3 module-title">Create Your Avatar</h6>
                        {% if curr_module == "Avatar" %}
                          <span class="badge bg-label-primary me-1">Do this next!</span>
                        {% endif %}
                      </div>
                      <span>
                        In this module, you will be creating an avatar that will represent you in our interview.
                      </span>
                    </div>
                    <div class="d-flex flex-column text-start text-lg-end">
                      <div class="d-flex order-sm-0 order-1">
                        {% if curr_module == "Avatar" %}
                          <a href="{% url 'create_avatar' %}" class="btn btn-label-primary" >Start the Module</a>
                        {% elif "Avatar" in completed_modules %}
                          <button class="btn btn-label-secondary" disabled>Done</button>
                        {% else %}
                          <button class="btn btn-label-secondary" disabled>Start the Module</button>
                        {% endif %}
                      </div>
                      <small class="mt-sm-auto mt-2 order-sm-1 order-0">Est. 2 minutes</small>
                    </div>
                  </div>
                </div>


                <div class="cardMaster border p-3 rounded mb-3 {% if curr_module == 'Interview (new_avp_full_v1)' %}active_module{% endif %}">
                  <div class="d-flex justify-content-between flex-sm-row flex-column">
                    <div class="card-information" style="width: 75%">
                      <p>
                        <i class="menu-icon tf-icons bx bx-chat"></i>
                        Step 1
                      </p>
                      <div class="d-flex align-items-center mb-1">
                        <h6 class="mb-0 me-3 module-title">Join the Interview</h6>
                        {% if curr_module == "Interview (new_avp_full_v1)" %}
                          <span class="badge bg-label-primary me-1">Do this next!</span>
                        {% endif %}
                      </div>
                      <p>
                        <strong>(Required component)</strong> <br>In this module, you will be participating in an interview in which our interviewer agent will ask you about a broad set of questions that are related to your life, values, and interests. 
                      </p>
                      <p>
                        <strong style="color:#9C1212">IMPORTANT:</strong> <br>Ensure the followings before starting the interview. 

                        <ul>
                          <li>
                            Please find a quiet place where you can talk comfortably during this interview. Background noise can make it difficult to record and pick up your voice, hindering the interview process.
                          </li>
                          <li>
                            Your computer will need a microphone, like the one you might have used for online calls (e.g., Zoom, Google Hangouts). If you are an AirPod user, we recommend <em>against</em> using its microphone for this interview.  
                          </li>
                          <li>
                            Please only use one of the following browsers: Chrome, Safari, Firefox, Opera, Edge
                          </li>
                        </ul>

                        <strong style="color:#9C1212">Please note (if the interview is stalling):</strong> <br><em>During the interview, three dots (loading sign) should only last on average 5 seconds, and maximum 30 seconds, and will proceed to the next question without you having to do anything. If the interviewer is not responding/stalling for longer than a minute, please <strong>refresh </strong>the page. Finally, we strongly recommend that you use a <strong>desktop/laptop</strong> for this part of the study (instead of a mobile/tablet device).</em> 
                      </p>
                      <p>
                        <!-- For demonstration only: <a href="% url 'transcript' 'script_v1' %">view interview transcript</a> -->
                      </p>
                    </div>
                    <div class="d-flex flex-column text-start text-lg-end">
                      <div class="d-flex order-sm-0 order-1">
                        {% if curr_module == "Interview (new_avp_full_v1)" %}
                          <button type="button" class="btn btn-label-primary" data-bs-toggle="modal" data-bs-target="#createApp">
                            {% if "new_avp_full_v1" in started_interviews_scripts %}
                              Resume the Module
                            {% else %}
                              Start the Module
                            {% endif %}
                          </button>
                        {% elif "Interview (new_avp_full_v1)" in completed_modules %}
                          <button class="btn btn-label-secondary" disabled>Done</button>
                        {% else %}
                          <button class="btn btn-label-secondary" disabled>Start the Module</button>
                        {% endif %}
                      </div>
                      <!-- <small class="mt-sm-auto mt-2 order-sm-1 order-0">Est. 2 hours</small> -->
                      <small class="mt-sm-auto mt-2 order-sm-1 order-0">Est. 2 hours</small>
                    </div>
                  </div>
                </div>



<!-- 
                <div class="cardMaster border p-3 rounded mb-3 ">
                  <div class="d-flex justify-content-between flex-sm-row flex-column">
                    <div class="card-information" style="width: 75%">
                      <p>
                        <i class="menu-icon tf-icons bx bx-chat"></i>
                        Exit Survey
                      </p>
                      <div class="d-flex align-items-center mb-1">
                        <h6 class="mb-0 me-3 module-title">Please do this after you finish the steps above!</h6>
                        
                      </div>
                      <p>
                        This section will ask you to give us your Prolific ID so we can process your work. Please only complete this after you have completed the sections above.
                      </p>
                    </div>
                    <div class="d-flex flex-column text-start text-lg-end">
                      <div class="d-flex order-sm-0 order-1">
                        <a href="https://stanforduniversity.qualtrics.com/jfe/form/SV_9Bllbeg3WEV2Hd4" target="_blank" class="btn btn-label-primary" >Enter the Survey</a>
                      </div>
                      <small class="mt-sm-auto mt-2 order-sm-1 order-0">Est. 3 minutes</small>
                    </div>
                  </div>
                </div>
 -->














{% if not request.user.behavioral_activated %}

                <div class="cardMaster border p-3 rounded mb-3 {% if curr_module == 'Survey Pt.1' %}active_module{% endif %}">
                  <div class="d-flex justify-content-between flex-sm-row flex-column">
                    <div class="card-information" style="width: 75%">
                      <p>
                        <i class="menu-icon tf-icons bx bx-notepad"></i>
                        Step 2
                      </p>
                      <div class="d-flex align-items-center mb-1">
                        <h6 class="mb-0 me-3 module-title">Take the First Survey</h6>
                        {% if curr_module == "Survey Pt.1" %}
                          <span class="badge bg-label-primary me-1">Do this next!</span>
                        {% endif %}
                      </div>
                      <span>
                        <strong>(Required component)</strong> <br> In this module, you will complete a survey similar to the General Social Survey, which inquires about your basic background information and views on various topics.

                        <br><br>
                        {% if request.user.get_curr_modules == "Survey Pt.1" %}
                          <strong style="color:#F72B25">IMPORTANT: For Step 2, please remember to submit your completion codes, "Isabella throws" and "a party" to the original qualtrics form that led you to this platform (the form that was provided by Forthright/SurveySavvy).</strong> (This is not for Step 3, the follow-up study, below! For Step 3, you will be given two additional surveys that will give you another pair of completion codes.)
                        {% endif %}
                        
                         
                      </span>

                      <br>
                      <br>
                      {% if survey_one_completion_form.errors %}
                        <div class="alert alert-danger" role="alert">
                            <strong>There were some problems with your submission:</strong>
                            <ul>
                                {% for field, errors in survey_one_completion_form.errors.items %}
                                    {% for error in errors %}
                                        <li><strong>{{ field }}:</strong> {{ error|escape }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                      {% endif %}

                    </div>
                    <div class="d-flex flex-column text-start text-lg-end">
                      <div class="d-flex order-sm-0 order-1">
                        <div class="d-flex order-sm-0 order-1">
                          {% if curr_module == "Survey Pt.1" %}
                            <button type="button" class="btn btn-label-primary" data-bs-toggle="modal" data-bs-target="#surveyPt1CompletionForm">Start the Module</button>
                          {% elif "Survey Pt.1" in completed_modules %}
                            <button class="btn btn-label-secondary" disabled>Done</button>
                          {% else %}
                            <button class="btn btn-label-secondary" disabled>Start the Module</button>
                          {% endif %}
                        </div>
                      </div>
                      <small class="mt-sm-auto mt-2 order-sm-1 order-0">Est. 1 hour</small>
                    </div>
                  </div>
                </div>




                <div class="cardMaster border p-3 rounded mb-3 {% if curr_module == 'Survey Pt.2' %}active_module{% endif %}">
                  <div class="d-flex justify-content-between flex-sm-row flex-column">
                    <div class="card-information" style="width: 75%">
                      <p>
                        <i class="menu-icon tf-icons bx bx-notepad"></i>
                        Step 3
                      </p>
                      <div class="d-flex align-items-center mb-1">
                        <h6 class="mb-0 me-3 module-title">Take the Second Survey (Follow-up study)</h6>
                        {% if curr_module == "Survey Pt.2" %}
                          <span class="badge bg-label-primary me-1">Do this next!</span>
                        {% endif %}
                      </div>
                      <span>
                        <strong>(This is for the follow-up survey. We will reach out to you after a couple of weeks of you completing the components above. You will be compensated additionally if you decide to join this follow-up survey. Please do not attempt this part until we reach out to you after two weeksof your completing Step 0 ~ 2.)</strong> 
                        <br><br>
                        In this module, you will complete a follow-up survey. Please note that you will be able to take this survey <em>two weeks</em> after you have completed Step 2.
                      </span>
                      <br><br>
                      <span>
                        Please note that this step is optional but strongly recommended, and you will be given extra compensation for participating. We will reach out with more details through the email you used to sign up.

                        
                        {% if request.user.get_curr_modules == "Survey Pt.2" %}
                        <br><br>
                          <strong style="color:#F72B25">IMPORTANT: Please remember to submit your completion codes, "Maria joins" and "Isabella's party" to the original qualtrics form that led you to this platform (the form that was provided by Forthright/SurveySavvy).</strong>
                        {% endif %}
                      </span>
                      <br><br>
                      This portion unlocks in: 
                      <div id="timer_wrap" style="">
                        {% if curr_timer %}
                          <script>
                              let first_sec = true;
                              let live = false; 
                              function startCountdown(duration, display) {
                                  var timer = duration;
                                  var interval = setInterval(function () {
                                      var days = parseInt(timer / 86400, 10);
                                      var hours = parseInt((timer % 86400) / 3600, 10);
                                      var minutes = parseInt((timer % 3600) / 60, 10);
                                      var seconds = parseInt(timer % 60, 10);

                                      if (first_sec) {
                                        if (timer > 0) {
                                          live = true;
                                          first_sec = false;
                                        }
                                      }

                                      hours = hours < 10 ? "0" + hours : hours;
                                      minutes = minutes < 10 ? "0" + minutes : minutes;
                                      seconds = seconds < 10 ? "0" + seconds : seconds;

                                      display.textContent = days + " days " + hours + " hours " + minutes + " minutes " + seconds + " seconds";

                                      if (--timer < 0) {
                                          clearInterval(interval);
                                          display.textContent = "00 days 00 hours 00 minutes 00 seconds";
                                          if (live) {
                                            document.getElementById('refreshForSurvey').style.display = 'block';
                                          }
                                      }
                                  }, 1000);
                              }

                              window.onload = function () {
                                console.log("???")
                                  var remainingTimeInSeconds = {{ curr_timer.get_remaining_seconds }}; // Adjusted to use the new method
                                  var display = document.querySelector('#timer'); // The element where you want to display the countdown
                                  startCountdown(remainingTimeInSeconds, display);
                              };
                          </script>
                          <div id="timer" style="font-weight: 800 !important; font-style: italic;"></div>

                          <a id="refreshForSurvey" class="btn btn-label-primary" href="{% url 'home' %}" style="display:none; margin-top:2em">Refresh to start the survey</a>
                        {% else %}
                          14 days 00 hours 00 minutes 00 seconds
                        {% endif %}

                        <br>
                        <br>
                        {% if survey_two_completion_form.errors %}
                          <div class="alert alert-danger" role="alert">
                              <strong>There were some problems with your submission:</strong>
                              <ul>
                                  {% for field, errors in survey_two_completion_form.errors.items %}
                                      {% for error in errors %}
                                          <li><strong>{{ field }}:</strong> {{ error|escape }}</li>
                                      {% endfor %}
                                  {% endfor %}
                              </ul>
                          </div>
                        {% endif %}
                      </div>
                    </div>

                    <div class="d-flex flex-column text-start text-lg-end">
                      <div class="d-flex order-sm-0 order-1">
                        <div class="d-flex order-sm-0 order-1">
                          {% if curr_module == "Survey Pt.2" %}
                            
                              {% if curr_timer.time_up %} 
                                <button type="button" class="btn btn-label-primary" data-bs-toggle="modal" data-bs-target="#surveyPt2CompletionForm">
                                Start the Module 
                                </button>
                              {% else %}
                                <button class="btn btn-label-secondary" disabled>Unlocks in {{ curr_timer.get_str_remaining_days}} days</button>
                              {% endif %}
                            
                          {% elif "Survey Pt.2" in completed_modules %}
                            <button class="btn btn-label-secondary" disabled>Done</button>
                          {% else %}
                            <button class="btn btn-label-secondary" disabled>Unlocks in 14 days</button>
                          {% endif %}
                        </div>
                      </div>
                      <small class="mt-sm-auto mt-2 order-sm-1 order-0">Est. 1 hour</small>
                    </div>

                  </div>
                </div>










{% else %}









 <!--  -->



                <div class="cardMaster border p-3 rounded mb-3 {% if curr_module == 'Behavioral Study Pt.1' %}active_module{% endif %}">
                  <div class="d-flex justify-content-between flex-sm-row flex-column">
                    <div class="card-information" style="width: 75%">
                      <p>
                        <i class="menu-icon tf-icons bx bx-notepad"></i>
                        Step 2
                      </p>
                      <div class="d-flex align-items-center mb-1">
                        <h6 class="mb-0 me-3 module-title">Take the Survey Experiments</h6>
                        {% if curr_module == "Behavioral Study Pt.1" %}
                          <span class="badge bg-label-primary me-1">Do this next!</span>
                        {% endif %}
                      </div>
                      <span>
                        In this module, you will complete a series of survey experiments, each of which will take approximately 2 to 10 minutes. 

                        {% if curr_module == "Behavioral Study Pt.1" %}
                          <br><br>
                          <strong>Instruction:</strong> There are a total of 14 studies. The experiments will appear one after another below this instruction. You will notice the number next to "Study #" increase by one as you complete each study, with 14 being the final one. Please click on "<strong>Go to the Experiment</strong>," which will direct you to the experiment. Follow the instructions on that page.

                          <br> 
                          <br> 
                          Importantly, the last page of the experiment will display a unique code that starts with "gabm..." (e.g., "gabm3B_qef2"). To proceed to the next study, copy and paste that code into the input box below.
                          <p>
                            <br>
                          {% for key, study in request.user.behavioral_module.get_study_rand_o_1.items %}
                            {% if study.current %}
                              <strong>You are currently working on Study #{{ forloop.counter }}</strong> <br>
                              Click here to <a href="{{ study.study_link }}" target="_blank"><strong>Go to the Experiment</strong></a>.<br>
                              <!-- &nbsp; &nbsp; Step 2 -- Click on this to <a href="{{ study.study_link }}">submit your experiment code</a> -->
                              <form id="experiment_one_code_form" action="{% url 'handler_upload_experiment_code' %}" method="post">
                                {% csrf_token %}
                                {{ Experiment_One_CodeForm|crispy }}
                                <input type="hidden" name="survey_part" value="1">
                                <br>
                                <button type="submit" class="btn btn-primary me-sm-3 me-1" style="width:100%">Submit the code to proceed </button>
                              </form>
                              <br>
                            {% else %}


                            {% endif %}
                          {% endfor %}
                          </p>
                        {% endif %}



                      </span>

                      <br>
                      <br>

                    </div>
                    <div class="d-flex flex-column text-start text-lg-end">
                      <div class="d-flex order-sm-0 order-1">
                        <div class="d-flex order-sm-0 order-1">
                          {% if curr_module == "Behavioral Study Pt.1" %}
                            <button type="button" class="btn btn-label-primary">Current</button>
                          {% elif "Behavioral Study Pt.1" in completed_modules %}
                            <button class="btn btn-label-secondary" disabled>Done</button>
                          {% else %}
                            <button class="btn btn-label-secondary" disabled>To Do</button>
                          {% endif %}
                        </div>
                      </div>
                      <small class="mt-sm-auto mt-2 order-sm-1 order-0">Est. 75 minutes</small>
                    </div>
                  </div>
                </div>



<!-- 
                <div class="cardMaster border p-3 rounded mb-3 {% if curr_module == 'Behavioral Study Pt.2' %}active_module{% endif %}">
                  <div class="d-flex justify-content-between flex-sm-row flex-column">
                    <div class="card-information" style="width: 75%">
                      <p>
                        <i class="menu-icon tf-icons bx bx-notepad"></i>
                        Step 3
                      </p>
                      <div class="d-flex align-items-center mb-1">
                        <h6 class="mb-0 me-3 module-title">Take the Second Survey</h6>
                        {% if curr_module == "Behavioral Study Pt.2" %}
                          <span class="badge bg-label-primary me-1">Do this next!</span>
                        {% endif %}
                      </div>
                      <span>
                        In this module, you will complete a follow-up survey. Please note that you will be able to take this survey <em>two weeks</em> after you have completed Step 2.
                      </span>
                      <br><br>
                      <span>
                        Please note that this step is optional but strongly recommended, and you will be given extra compensation for participating. We will reach out with more details through the email you used to sign up.
                      </span>
                      <br><br>
                      This portion unlocks in: 
                      <div id="timer_wrap" style="">
                        {% if curr_timer %}
                          <script>
                              let first_sec = true;
                              let live = false; 
                              function startCountdown(duration, display) {
                                  var timer = duration;
                                  var interval = setInterval(function () {
                                      var days = parseInt(timer / 86400, 10);
                                      var hours = parseInt((timer % 86400) / 3600, 10);
                                      var minutes = parseInt((timer % 3600) / 60, 10);
                                      var seconds = parseInt(timer % 60, 10);

                                      if (first_sec) {
                                        if (timer > 0) {
                                          live = true;
                                          first_sec = false;
                                        }
                                      }

                                      hours = hours < 10 ? "0" + hours : hours;
                                      minutes = minutes < 10 ? "0" + minutes : minutes;
                                      seconds = seconds < 10 ? "0" + seconds : seconds;

                                      display.textContent = days + " days " + hours + " hours " + minutes + " minutes " + seconds + " seconds";

                                      if (--timer < 0) {
                                          clearInterval(interval);
                                          display.textContent = "00 days 00 hours 00 minutes 00 seconds";
                                          if (live) {
                                            document.getElementById('refreshForBehaviorExperiment').style.display = 'block';
                                          }
                                      }
                                  }, 1000);
                              }

                              window.onload = function () {
                                console.log("???")
                                  var remainingTimeInSeconds = {{ curr_timer.get_remaining_seconds }}; // Adjusted to use the new method
                                  var display = document.querySelector('#timer'); // The element where you want to display the countdown
                                  startCountdown(remainingTimeInSeconds, display);
                              };
                          </script>
                          <div id="timer" style="font-weight: 800 !important; font-style: italic;"></div>

                          <a id="refreshForBehaviorExperiment" class="btn btn-label-primary" href="{% url 'home' %}" style="display:none; margin-top:2em">Refresh to start the study</a>
                        {% else %}
                          14 days 00 hours 00 minutes 00 seconds
                        {% endif %}

                        <br>
                        <br>
                        {% if survey_two_completion_form.errors %}
                          <div class="alert alert-danger" role="alert">
                              <strong>There were some problems with your submission:</strong>
                              <ul>
                                  {% for field, errors in survey_two_completion_form.errors.items %}
                                      {% for error in errors %}
                                          <li><strong>{{ field }}:</strong> {{ error|escape }}</li>
                                      {% endfor %}
                                  {% endfor %}
                              </ul>
                          </div>
                        {% endif %}
                      </div>
                    </div>

                    <div class="d-flex flex-column text-start text-lg-end">
                      <div class="d-flex order-sm-0 order-1">
                        <div class="d-flex order-sm-0 order-1">
                          {% if curr_module == "Behavioral Study Pt.2" %}
                            
                              {% if curr_timer.time_up %} 
                                <button type="button" class="btn btn-label-primary" data-bs-toggle="modal" data-bs-target="#surveyPt2CompletionForm">
                                Start the Module 
                                </button>
                              {% else %}
                                <button class="btn btn-label-secondary" disabled>Unlocks in {{ curr_timer.get_str_remaining_days}} days</button>
                              {% endif %}
                            
                          {% elif "Behavioral Study Pt.2" in completed_modules %}
                            <button class="btn btn-label-secondary" disabled>Done</button>
                          {% else %}
                            <button class="btn btn-label-secondary" disabled>Unlocks in 14 days</button>
                          {% endif %}
                        </div>
                      </div>
                      <small class="mt-sm-auto mt-2 order-sm-1 order-0">Est. 75 minutes</small>
                    </div>

                  </div>
                </div>

 -->










{% endif %}
























              </div>
            </div>
          </div>


          <div class="col-lg-4">
            <div class="card-header align-items-center">
              <h5 class="card-action-title mb-0">Study Instructions</h5>
            </div>
            <div class="card-body">
              <!-- <small class="text-muted text-uppercase"></small> -->
              <p>Thank you again for participating in our study!</p>
              <p>
                Your task is to complete the modules shown on the left (or above, depending on your screen size). 
                The modules will become available one by one. Please start with the module that is marked with the "DO THIS NEXT!" sign.
              </p>
            </div>

           <!--  <div class="card-body">
              <small class="text-muted text-uppercase">FOR THE PROLIFIC PARTICIPANTS</small>
              <p>
                This study platform is in beta testing mode. You only need to complete the first two modules. The platform, by default, asks for your email when you consent. But for the beta participants, we will not be contacting you as we are not testing the second portion of this study.
              </p>
            </div> -->
          </div>

        </div>
      </div>

    </div>
  </div>
{% endblock content %}


{% block modal_block %}
  <!-- Consent Form Modal -->
  <div class="modal fade" id="consentForm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-simple modal-edit-user">
      <div class="modal-content p-3 p-md-5">
        <div class="modal-body">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          <div class="text-center mb-4">
            <h3>Consent to the Study</h3>
            <p style="text-align: left;">Please review the consent form provided in this link: <a href="https://docs.google.com/document/d/1BuuySmc8TSnAmwMvO1wisANiE2WruLEGojSDikor28U/edit?usp=sharing" target="_blank">Consent Form</a>. Please type your first and last name, and your email below to consent to the study.</p>
          </div>
          <form id="consent_form" action="{% url 'handler_consent' %}" method="post">
            {% csrf_token %}
            {{ consent_form|crispy }}
            <br>
            <button type="submit" class="btn btn-primary me-sm-3 me-1" style="width:100%">I consent to participating in the study</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!--/ Consent Form Modal -->

  <!-- Join the interview Modal -->
  <div class="modal fade" id="createApp" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-simple modal-upgrade-plan">
      <div class="modal-content p-3 p-md-5">
        <div class="modal-body p-2">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          <div class="text-center">
            <h3 class="mb-2">Are you ready to start the interview?</h3><br>
          </div>
          <!-- App Wizard -->
          <div id="wizard-create-app" class="bs-stepper vertical mt-2 shadow-none border-0">
            <div class="bs-stepper-header border-0 p-1">
              
              <div class="step" data-target="#details">
                <button type="button" class="step-trigger" disabled>
                  <span class="bs-stepper-circle"><i class="bx bx-file fs-5"></i></span>
                  <span class="bs-stepper-label">
                    <span class="bs-stepper-title text-uppercase">Test Audio</span>
                  </span>
                </button>
              </div>

              <div class="line"></div>
              <div class="step" data-target="#calibrationSubmit">
                <button type="button" class="step-trigger" disabled>
                  <span class="bs-stepper-circle"><i class="bx bx-check fs-5"></i></span>
                  <span class="bs-stepper-label">
                    <span class="bs-stepper-title text-uppercase">Start</span>
                  </span>
                </button>
              </div>

            </div>
            <div class="bs-stepper-content p-1">
              <div id="details" class="content pt-3 pt-lg-0">
                <p>Before we start, we want to make sure that your audio is working properly! Please find a quiet place with a microphone. When you are ready, 1) press the "Start calibration" button below, and 2) read out loud the lines below.</p>

                <div class="mb-3" style="border:solid; border-radius: 1.2em; padding:1.2em">
                  <div style="margin-bottom:1.2em; margin-top:0.8em">
                    <button id="calibrateButton" class="btn btn-outline-dark">
                      Start calibration
                    </button>
                  </div>
                  <p>
                    <em>Please read out loud (repeat if needed)</em>: In my younger and more vulnerable years my father gave me some advice that I've been turning over in my mind ever since. Whenever you feel like criticizing anyone, he told me, just remember that all the people in this world haven't had the advantages that you've had.
                  </p>
                  <p style="margin-bottom:1.2em; ">
                    <!-- <em>(Progress: <span id="calibrationProgress">0</span>% completed)</em> -->
                    <div class="d-flex justify-content-between align-items-center gap-3">
                      <div class="progress w-100" style="height: 10px">
                        <div
                          id="calibrationProgressBar"
                          class="progress-bar bg-success"
                          role="progressbar"
                          style="width: 0%"
                          aria-valuenow="0"
                          aria-valuemin="0"
                          aria-valuemax="100"></div>
                      </div>
                      <small class="fw-medium"  style="width: 60px; text-align: right;"><span id="calibrationProgress">0</span>%</small>
                    </div>
                  </p>
                </div>
                
                <p><br>Please press the next button below when you have completed the calibration step. </p>

                <div class="col-12 d-flex justify-content-between mt-4">
                  <button id="interviewPrepStepOneDoneButton" class="btn btn-primary btn-next" style="width:100%" disabled>
                    <span class="align-middle d-sm-inline-block d-none me-sm-1">Next</span>
                    <i class="bx bx-right-arrow-alt bx-xs"></i>
                  </button>
                </div>

              </div>

              <!-- submit -->
              <div id="calibrationSubmit" class="content text-center pt-3 pt-lg-0">
                <h5 class="mb-2 mt-3">Before you start... </h5>
                <p>Please be sure to find a quiet place.</p>
                <!-- image -->
                <img
                  src="{% static 'gabm/sneat/assets/img/illustrations/man-with-laptop-light.png' %}"
                  alt="Create App img"
                  width="200"
                  class="img-fluid"
                  data-app-light-img="illustrations/man-with-laptop-light.png"
                  data-app-dark-img="illustrations/man-with-laptop-dark.png" />
                <div class="col-12 d-flex justify-content-between mt-4 pt-2">
                  <form method="post" action="{% url 'handler_calibration' %}" style="width: 100%;">
                    {% csrf_token %}
                    <input type="hidden" name="audioCalibrationFloat" value="hiddenValue-testetest">
                    <input type="hidden" name="script_v" value="new_avp_full_v1">
                    <button type="submit" class="btn btn-success" style="width:100%">I am ready to start the interview</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!--/ App Wizard -->
      </div>
    </div>
  </div>
  <!--/ Join the interview Modal -->




{% if not request.user.behavioral_activated %}

  <!-- Survey Pt 1 Modal -->
  <div class="modal fade" id="surveyPt1CompletionForm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-simple modal-edit-user">
      <div class="modal-content p-3 p-md-5">
        <div class="modal-body">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          
          <div class="text-center mb-4">
            <h3>Take the Survey</h3>
            <p style="text-align: left;">Please complete the survey in BOTH of the links below in the order presented below (complete "Survey Part 1" first. Once you are done, complete "Survey Part 2.")
              <br><br>
              <!-- IMPORTANT: Once you complete the survey below, you will receive two survey codes (one from each). Please copy and paste them into the box labeled "Enter your survey code" and submit (just put the two codes together). -->
              <!-- Complete the two surveys (the survey links will ask for your Prolific id/name -- we will use those to know that it was you!) -->
              IMPORTANT: Each of the survey will give you a unique survey completion code. <strong style="color:#C8231E">Please enter them below AND in the Qualtrics form provided by Forthright or SurveySavvy (whichever you were recruited from) that brought you to this study platform.</strong> This is how we know that you completed this part of the study.<br><br>(Hint: The first code starts with "Isa...", and the second code starts with "a pa..." If you do not enter the correct codes, it will just take you back to the original page. You can re-enter the code, however.)

            </p>
            <p>
              <!-- <strong><a href="https://stanforduniversity.qualtrics.com/jfe/form/SV_cMeXjhemOewmbJQ" target="_blank">Survey Link</a></strong> -->
              <p style="padding:0.1em; padding-top:0.1em">
                <strong><a href="{{request.user.get_survey_link_pt1}}&wave=1" target="_blank">[Link] Survey Part 1</a></strong>
              </p>
              <p style="padding:0.1em; padding-bottom:0em">
                <strong><a href="{{request.user.get_survey_link_pt2}}&wave=1" target="_blank">[Link] Survey Part 2</a></strong>
              </p>
            </p>
          </div>

          <hr>
          
          <form id="survey_one_completion_form" action="{% url 'handler_upload_surveycode' %}" method="post" style="line-height: 1.5em !important;">
            {% csrf_token %}
            {{ survey_one_completion_form|crispy }}
            <input type="hidden" name="survey_part" value="1">
            <br>
            <button type="submit" class="btn btn-primary me-sm-3 me-1" style="width:100%">Submit the survey completion code</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!--/ Survey Pt 1 Modal -->


  <!-- Survey Pt 2 Modal -->
  <div class="modal fade" id="surveyPt2CompletionForm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-simple modal-edit-user">
      <div class="modal-content p-3 p-md-5">
        <div class="modal-body">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          
          <div class="text-center mb-4">
            <h3>Take the Second Survey</h3>
            <p style="text-align: left;">Please complete the survey in BOTH of the links below in the order presented below (complete "Survey Part 1" first. Once you are done, complete "Survey Part 2.")
              <br><br>
              IMPORTANT: Each of the survey will give you a unique survey completion code. <strong style="color:#C8231E">Please enter them below AND in the Qualtrics form provided by Forthright or SurveySavvy (whichever you were recruited from) that brought you to this study platform.</strong>Please enter them below. This is how we know that you completed this part of the study. <br><br>(Hint: The first code starts with "Mar...", and the second code starts with "Isa...")
            </p>
            <p>
              <p style="padding:0.1em; padding-top:0.1em">
                <strong><a href="{{request.user.get_survey_link_pt1}}&wave=2" target="_blank">[Link] Survey Part 1</a></strong>
              </p>
              <p style="padding:0.1em; padding-bottom:0em">
                <strong><a href="{{request.user.get_survey_link_pt2}}&wave=2" target="_blank">[Link] Survey Part 2</a></strong>
              </p>
            </p>
          </div>

          <hr>

          <form id="survey_two_completion_form" action="{% url 'handler_upload_surveycode' %}" method="post">
            {% csrf_token %}
            {{ survey_two_completion_form|crispy }}
            <input type="hidden" name="survey_part" value="2">
            <br>
            <button type="submit" class="btn btn-primary me-sm-3 me-1" style="width:100%">Submit the survey completion code</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!--/ Survey Pt 2 Modal -->


{% endif %}





{% endblock modal_block %}



{% block js_content %}
  <script src="{% static 'gabm/sneat/assets/vendor/libs/cleavejs/cleave.js' %}"></script>
  <script src="{% static 'gabm/sneat/assets/vendor/libs/cleavejs/cleave-phone.js' %}"></script>
  <script src="{% static 'gabm/sneat/assets/vendor/libs/select2/select2.js' %}"></script>
  <script src="{% static 'gabm/sneat/assets/vendor/libs/@form-validation/umd/bundle/popular.min.js' %}"></script>
  <script src="{% static 'gabm/sneat/assets/vendor/libs/@form-validation/umd/plugin-bootstrap5/index.min.js' %}"></script>
  <script src="{% static 'gabm/sneat/assets/vendor/libs/@form-validation/umd/plugin-auto-focus/index.min.js' %}"></script>
  <script src="{% static 'gabm/sneat/assets/vendor/libs/bs-stepper/bs-stepper.js' %}"></script>

  <script src="{% static 'gabm/sneat/assets/js/modal-create-app.js' %}"></script>
  <script>
      let audioContext = new (window.AudioContext || window.webkitAudioContext)();

      // Settings and parameters: 
      let calibrationBufferDuration = 50; 
      let calibrationSlackRate = 0.75;
      let silenceGuaranteeThreshold = 0.01;
      let speechThreshold = 0.02;
      let speechThresholdCalibrated = false;

      function updateProgressBar(currentNumber) {
          var progressBar = document.getElementById("calibrationProgressBar");
          progressBar.style.width = currentNumber + '%';
          progressBar.setAttribute('aria-valuenow', currentNumber);
      }

      document.getElementById('calibrateButton').addEventListener('click', function() {
        document.getElementById("calibrateButton").innerText = "Calibrating the audio";
        document.getElementById("calibrateButton").disabled = true;

        let list_buffer_rms = [];

        // Check for non-null
        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia ({audio: true})
            .then(function(stream) {
              const audioContext = new (window.AudioContext || window.webkitAudioContext)();
              const source = audioContext.createMediaStreamSource(stream);
              const processor = audioContext.createScriptProcessor(4096, 1, 1);

              source.connect(processor);
              processor.connect(audioContext.destination);

              processor.onaudioprocess = function(e) {
                // Get the buffer of audio data
                const buffer = e.inputBuffer.getChannelData(0);

                // Root Mean Square (RMS) is a statistical measure of the 
                // magnitude of a varying quantity. It's commonly used in 
                // physics, engineering, and signal processing to represent 
                // the average power or amplitude of a signal, especially 
                // when it varies over time.
                let sum = 0;
                for(let i = 0; i < buffer.length; i++) {
                    sum += buffer[i] * buffer[i]; // sum of squares
                }
                let rms = Math.sqrt(sum / buffer.length);
                // Update the average noise level display/processing
                console.log("Current RMS: " + rms);

                if (rms > silenceGuaranteeThreshold) {
                  list_buffer_rms.push(rms);

                  var element = document.getElementById('calibrationProgress');
                  var currentNumber = parseInt(element.innerText);
                  currentNumber += 100/calibrationBufferDuration; 
                  element.innerText = currentNumber;

                  updateProgressBar(currentNumber);
                }; 

                if (list_buffer_rms.length >= calibrationBufferDuration) {
                  // Disconnecting the processor and source for now. 
                  processor.disconnect();
                  source.disconnect();
                  // Calibrating the threshold. 
                  let sum = list_buffer_rms.reduce(function (accumulator, currentValue) {
                      return accumulator + currentValue;
                  }, 0);

                  let rms_average = sum / list_buffer_rms.length;
                  speechThreshold = rms_average * calibrationSlackRate;
                  speechThresholdCalibrated = true;
                  // Removing the event listener.
                  processor.onaudioprocess = null;
                  console.log("Stopping the calibration process");
                  console.log("New speechThreshold" + speechThreshold);
                  document.getElementById("interviewPrepStepOneDoneButton").disabled = false;
                  document.getElementsByName("audioCalibrationFloat")[0].value = speechThreshold;
                  document.getElementById("calibrateButton").innerText = "Finished calibrating the audio";

                  processor.disconnect();
                  source.disconnect();
                  audioContext.close(); // Optionally close the context if it's no longer needed
                };
              };
            })
            .catch(function(err) {
              console.log('The following gUM error occurred: ' + err);
            });
        } else {
           console.log('getUserMedia not supported on your browser!');
        }
      });
      
    </script>
{% endblock js_content %}

















